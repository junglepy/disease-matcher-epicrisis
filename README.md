# Disease Matcher - Epicrisis Service

Сервис для анализа медицинских эпикризов с извлечением симптомов, поиском генетических заболеваний и генерацией клинических рекомендаций.

## Быстрый старт

### 1. Настройка
```bash
cp .env.example .env
# Отредактируйте .env - добавьте OPENAI_API_KEY
```

### 2. Запуск через Docker Compose
```bash
docker-compose up -d
```

Сервисы:
- Epicrisis API: http://localhost:8004
- LIRICAL Service: http://localhost:8083

### 3. Проверка работы
```bash
# health check
curl http://localhost:8004/api/v1/health

# Тестовый запрос
curl -X POST http://localhost:8004/api/v1/match_epicrisis \
  -H "Content-Type: application/json" \
  -d '{
    "epicrisis_text": "Мальчик 5 лет с задержкой развития, судорогами и гипотонией",
    "language": "ru",
    "top_k": 5
  }'
```

## API Endpoints

### POST /api/v1/match_epicrisis
Анализ эпикриза и поиск заболеваний.

**Request:**
```json
{
  "epicrisis_text": "Текст эпикриза на русском языке",
  "language": "ru",
  "top_k": 10
}
```

**Response:**
```json
{
  "results": [
    {
      "rank": 1,
      "omim_id": "123456",
      "name": "Disease Name",
      "score": 0.85,
      "genes": ["GENE1", "GENE2"]
    }
  ],
  "metadata": {
    "processing_time_ms": 3500,
    "architecture": "epicrisis_lirical"
  },
  "extended": {
    "extracted_symptoms": ["симптом1", "симптом2"],
    "hpo_codes": ["HP:0001234", "HP:0005678"],
    "clinical_notes": {
      "summary": "Краткое резюме анализа",
      "key_findings": ["Ключевые находки"],
      "recommendations": "Рекомендации по генетическому тестированию"
    }
  }
}
```

## Архитектура

1. **Извлечение симптомов** - Enhanced Symptom Extractor (с синонимами)
2. **Поиск HPO** - BM25 + LLM валидация
3. **Recursive Analysis** - Итеративное уточнение через LIRICAL
4. **Предсказание заболеваний** - LIRICAL Bayesian analysis
5. **Клинические рекомендации** - Опциональная генерация заметок для врачей

## Метрики производительности

На тестовом датасете из 100 эпикризов система показывает следующие результаты:

### Извлечение HPO кодов
- **Точность (Precision)**: 31.3%
- **Полнота (Recall)**: 67.9%
- **F1-score**: 41.5%

### Точность предсказания заболеваний
- **Accuracy**: 34.0%
- **HitRate@5**: 51.0%
- **HitRate@10**: 57.0%

### Производительность
- **Среднее время ответа**: 81.1 секунды
- **Всего тестовых случаев**: 100


### Как работает рекурсивный анализ

Система начинает с первичных HPO кодов, найденных для симптомов пациента, и отправляет их в LIRICAL - инструмент для вероятностной диагностики генетических заболеваний. LIRICAL использует байесовский подход: для каждого заболевания он вычисляет вероятность на основе того, какие симптомы присутствуют у пациента, какие отсутствуют, и как часто эти симптомы встречаются при данном заболевании. После получения списка вероятных заболеваний, система анализирует топ-30 из них и проверяет, не упустили ли мы какие-то HPO коды для уже найденных симптомов (например, "слабость мышц" может соответствовать разным HPO кодам). С помощью LLM система переоценивает соответствие между текстом эпикриза и расширенным набором HPO кодов, выбирая наиболее точные. Процесс повторяется с обновленным набором HPO кодов для улучшения точности сопоставления. Такой итеративный подход позволяет наиболее полно извлечь информацию из эпикриза и повысить точность диагностики.

## Ключевые возможности

- **Работа с русским языком** - извлечение симптомов из русских эпикризов
- **Рекурсивный анализ** - итеративное улучшение результатов
- **Клинические заметки** - конкретные рекомендации по генетическому тестированию
## Пример использования

**Запрос:**
```bash
curl -X POST http://localhost:8004/api/v1/match_epicrisis \
  -H "Content-Type: application/json" \
  -d '{
    "epicrisis_text": "Мальчик 3 года поступил с жалобами на задержку моторного развития, гипертонию и слабость мышц конечностей. При осмотре отмечается лицевой паралич и ригидность мышц. Сложности с кормлением в раннем возрасте.",
    "language": "ru",
    "top_k": 5
  }'
```

**Ответ системы:**
- Извлеченные симптомы: задержка моторного развития, гипертония, слабость мышц, лицевой паралич, ригидность мышц
- Найденные HPO коды: HP:0001276, HP:0010628, HP:0002063, HP:0003690, HP:0001270, HP:0008872
- Топ-5 заболеваний: OMIM:616323, OMIM:161800, OMIM:609285, OMIM:608930, OMIM:254940
- Рекомендации: "Генетическое тестирование: секвенирование гена CHRND (наиболее частая причина). При отрицательном результате рассмотреть тестирование генов CHRNA1 и ACTA1."

## Настройка параметров

В файле `.env` можно настроить:
- `RECURSIVE_ITERATIONS` - количество итераций рекурсивного анализа (по умолчанию: 2)
- `FINAL_DISEASE_RERANK_ENABLED` - включить генерацию клинических заметок (по умолчанию: false)
- `HPO_FREQUENCY_THRESHOLD` - минимальная частота симптома для включения в анализ (по умолчанию: 0.1)

## Обработка Excel файлов с эпикризами

Для пакетной обработки эпикризов из Excel файлов используйте скрипт `process_epicrisis_excel.py`:

### Основные возможности
- Обработка текстов эпикризов из первой колонки Excel файла
- Добавление результатов анализа в новые колонки
- Промежуточное сохранение каждые 10 строк
- Возможность продолжить с определенной строки при сбое
- Прогресс-бар для отслеживания процесса

### Использование

```bash
# Базовый запуск (обрабатывает первую колонку файла)
python process_epicrisis_excel.py input_file.xlsx

# Указать выходной файл
python process_epicrisis_excel.py input_file.xlsx --output output_file.xlsx

# Продолжить обработку с 10-й строки
python process_epicrisis_excel.py input_file.xlsx --start-from 10

# Использовать другой API endpoint
python process_epicrisis_excel.py input_file.xlsx --api-url http://localhost:8004
```

### Параметры
- `input_file` - путь к входному Excel файлу (обязательный)
- `--output`, `-o` - путь к выходному файлу (по умолчанию: input_file_processed.xlsx)
- `--api-url` - URL API эпикризов (по умолчанию: http://localhost:8004/api/v1/match_epicrisis)
- `--start-from` - с какой строки начать обработку, 0-based (по умолчанию: 0)
- `--delay` - задержка между запросами в секундах (по умолчанию: 0.5)
- `--top-k` - количество заболеваний для возврата (по умолчанию: 10)

### Формат входных данных
Скрипт обрабатывает **первую колонку** Excel файла, которая должна содержать тексты эпикризов.

### Формат результата
Скрипт создает новый Excel файл с суффиксом `_processed`, содержащий:
- Все исходные данные
- Новые колонки:
  - `HPO_коды` - извлеченные HPO коды симптомов
  - `HPO_названия` - названия HPO терминов
  - `Заболевания_коды` - коды найденных заболеваний (OMIM/MONDO)
  - `Заболевания_названия` - названия заболеваний
  - `Топ1_заболевание` - наиболее вероятное заболевание
  - `Топ1_score` - степень уверенности для топ-1 заболевания
  - `Клинические_рекомендации` - рекомендации по генетическому тестированию (если включены в API)

### Пример

```bash
# Обработка файла с эпикризами в первой колонке
python process_epicrisis_excel.py "Эпикризы_2024.xlsx"

# Результат: Эпикризы_2024_processed.xlsx с добавленными колонками
```

### Логирование
Скрипт создает файл `process_epicrisis.log` с подробной информацией о процессе обработки.

### Требования
- Python 3.7+
- Установленные зависимости: pandas, openpyxl, requests, tqdm
- Запущенный сервис эпикризов на указанном URL

## Остановка сервисов
```bash
docker-compose down
```